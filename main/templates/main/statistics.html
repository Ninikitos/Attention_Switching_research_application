{% extends 'base.html' %}

{% block title %}Resuls{% endblock %}

{% block content %}
    <div class="container d-flex justify-content-center mt-5">
        <div class="card shadow col-8">
            <div class="card-body p-4">
                <h1 class="mb-4">Study finished.</h1>
                <div class="row mb-4">
                    <div class="col-md-3">
                        <h3>{{ total_rounds }}</h3>
                        <p class="text-muted">Rounds</p>
                    </div>
                    <div class="col-md-3">
                        <h3>{{ total_time }}</h3>
                        <p class="text-muted">Total time</p>
                    </div>
                    <div class="col-md-3">
                        <h3>{{ average_time|floatformat:2 }}s</h3>
                        <p class="text-muted">Average time</p>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>Round</th>
                            <th>Time (sec)</th>
                            <th>Target letters</th>
                            <th>Selection</th>
                            <th>Web matrix</th>
                            <th>Mobile matrix</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for round in rounds %}
                            <tr>
                                <td>{{ round.round_number }}</td>
                                <td>{{ round.response_time|floatformat:2 }}</td>
                                <td>{{ round.target_letters|join:', ' }}</td>
                                <td>{{ round.web_selection.letters|join:', ' }}</td>
                                <td>{{ round.web_matrix }}</td>
                                <td>{{ round.mobile_matrix }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="text-center mt-4">
                    <a hx-post="{% url 'main:api_stop_session' session_id=session.session_id %}" class="btn btn-primary">
                        Start over
                    </a>
                    <a href="{% url 'main:download_csv' session_id=session.session_id %}"
                       class="btn btn-outline-success">
                        Download CSV
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script>
        const socket = new WebSocket('ws://' + window.location.host + '/ws/session/{{ session.session_id }}/');
        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            if (data.type === 'session_stop') {
                window.location.href = "{% url 'main:index' %}";
            }
        };
    </script>
{% endblock %}